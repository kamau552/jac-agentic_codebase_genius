"""
Codebase Genius - Working Jac Version
Based on actual byLLM syntax patterns
"""

import from py_helpers.clone_repo { clone_repo, list_files, read_readme, summarize_readme }
import from py_helpers.parse_code { scan_repo_for_python, build_call_graph }
import from py_helpers.make_diagram { make_function_call_graph }
import os;

node Repository {
    has url: str = "";
    has path: str = "";
    has name: str = "";
    has status: str = "initialized";
    has file_tree: list = [];
    has readme_summary: str = "";
    has parse_results: dict = {};
    has call_graph: list = [];
    has docs_path: str = "";
    
    def save_documentation(output_dir: str) -> str {
        output_path = os.path.join(output_dir, self.name);
        os.makedirs(output_path, exist_ok=True);
        
        # Build markdown
        md = "# " + self.name + " - Documentation\n\n";
        md = md + "**Repository:** " + self.url + "\n\n";
        md = md + "**Generated by:** Codebase Genius\n\n";
        md = md + "---\n\n";
        
        md = md + "## ğŸ“– Overview\n\n";
        md = md + self.readme_summary + "\n\n";
        
        # Statistics
        md = md + "## ğŸ“Š Repository Statistics\n\n";
        total_files = sum([len(item["files"]) for item in self.file_tree]);
        md = md + "- **Total Files:** " + str(total_files) + "\n";
        
        total_funcs = 0;
        for file_path in self.parse_results.keys() {
            file_data = self.parse_results[file_path];
            if file_data.get("success") {
                total_funcs = total_funcs + len(file_data.get("functions", []));
            }
        }
        md = md + "- **Python Functions:** " + str(total_funcs) + "\n\n";
        
        # File Structure
        md = md + "## ğŸ“ File Structure\n\n```\n";
        count = 0;
        for item in self.file_tree {
            if count >= 10 {
                break;
            }
            md = md + item["path"] + "/\n";
            count = count + 1;
        }
        md = md + "```\n\n";
        
        # Diagram if available
        if len(self.call_graph) > 0 {
            diagram_path = os.path.join(output_path, "call_graph");
            title = self.name + " - Function Calls";
            result = make_function_call_graph(self.call_graph, diagram_path, title);
            if result.get("success") {
                md = md + "## ğŸ”— Function Call Graph\n\n";
                md = md + "![Call Graph](call_graph.png)\n\n";
            }
        }
        
        # Save file
        docs_path = os.path.join(output_path, "docs.md");
        with open(docs_path, "w") as f {
            f.write(md);
        }
        
        self.docs_path = docs_path;
        self.status = "completed";
        return docs_path;
    }
}

walker CodebaseGenius {
    has github_url: str = "";
    has output_dir: str = "./outputs";
    
    obj __specs__ {
        static has auth: bool = False;
    }
    
    can process_repository with `root entry {
        print("ğŸš€ Starting Codebase Genius for: " + self.github_url);
        
        # Clone repository
        print("ğŸ“¦ Cloning repository...");
        clone_result = clone_repo(self.github_url);
        
        if not clone_result.get("success") {
            print("âŒ Clone failed: " + clone_result.get("error"));
            report {"status": "error", "message": clone_result.get("error")};
            disengage;
        }
        
        # Create repository node
        repo = Repository(
            url=self.github_url,
            path=clone_result["path"],
            name=clone_result["name"]
        );
        
        print("âœ… Cloned to: " + repo.path);
        
        # Map file tree
        print("ğŸ“‚ Mapping file structure...");
        repo.file_tree = list_files(repo.path);
        total_files = sum([len(item["files"]) for item in repo.file_tree]);
        print("âœ… Found " + str(total_files) + " files");
        
        # Read README
        print("ğŸ“– Reading README...");
        readme_data = read_readme(repo.path);
        if readme_data.get("success") {
            repo.readme_summary = summarize_readme(readme_data["content"]);
            print("âœ… README summarized");
        } else {
            repo.readme_summary = "No README found";
            print("âš ï¸  No README found");
        }
        
        # Analyze code
        print("ğŸ” Analyzing Python code...");
        repo.parse_results = scan_repo_for_python(repo.path);
        repo.call_graph = build_call_graph(repo.parse_results);
        
        total_funcs = 0;
        for file_path in repo.parse_results.keys() {
            file_data = repo.parse_results[file_path];
            if file_data.get("success") {
                total_funcs = total_funcs + len(file_data.get("functions", []));
            }
        }
        print("âœ… Found " + str(total_funcs) + " functions");
        print("âœ… Built call graph with " + str(len(repo.call_graph)) + " edges");
        
        # Generate documentation
        print("ğŸ“ Generating documentation...");
        docs_path = repo.save_documentation(self.output_dir);
        print("âœ… Documentation generated: " + docs_path);
        
        report {
            "status": "success",
            "repository": repo.name,
            "docs_path": docs_path,
            "stats": {
                "files": total_files,
                "functions": total_funcs,
                "call_edges": len(repo.call_graph)
            }
        };
    }
}

walker test_system {
    obj __specs__ {
        static has auth: bool = False;
    }
    
    can run_test with `root entry {
        print("ğŸ§ª Running test...");
        test_url = "https://github.com/psf/requests";
        genius = CodebaseGenius(github_url=test_url);
        visit root;
    }
}

walker serve_documentation {
    has github_url: str = "";
    
    obj __specs__ {
        static has auth: bool = False;
    }
    
    can serve with `root entry {
        print("ğŸŒ API Request received for: " + self.github_url);
        genius = CodebaseGenius(github_url=self.github_url);
        visit root;
    }
}

# Auto-run test on file execution
with entry {
    print("ğŸ§ª Running test system...");
    test_url = "https://github.com/psf/requests";
    genius = CodebaseGenius(github_url=test_url);
}